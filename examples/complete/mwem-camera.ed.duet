-- MWEM in Contextual Duet
let mwem =  Î› m : â„•, n  : â„•, Îµ  : â„âº, t : â„• .
           -- data set B over domain D
           pÎ» B : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 ,
              -- set Q of linear queries
              Q : ğ•„ [Lâˆ, U|m, nâ†¦ âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„• ] â‹… 1.0 ,
              -- number of iterations T
              T  : â„•[t] â‹… 1.0,
              -- privacy parameter Ïµ > 0
              Îµ  : â„âº[Îµ] â‹… 1.0,
              -- starting synthetic data: n times the uniform distribution over D
              Aâ‚€ : ğ•„[Lâˆ, U|m, nâ†¦ğ”»] â‹… 1.0,
              -- term-level matrix dimensions
              m  : â„•[m] â‹… 1.0,
              n  : â„•[n] â‹… 1.0 â‡’
  -- for iteration i = 1,...,T
  seqloop @ Îµ @ T @ m @ n B
    (pÎ» Aáµ¢â‚‹â‚ : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 â‡’
      -- select a query qáµ¢ âˆˆ Q using the exponential mechanism
      -- parameterized with epsilon value Ïµ/2T and the score function
      -- sáµ¢(B, q) = |q(Aáµ¢â‚‹â‚) - q(B)|
      qáµ¢ â† exponential @ m @ n @ âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„• @ â„âº[1.0] @ Ïµ/2T @ <B>
            (sÎ» Bâ€² : ğ•„ [Lâˆ, U|m, nâ†¦ğ”»]
              â‡’ (sÎ» qâ€² : âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„•
                â‡’ (abs (qâ€² @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”»] Aáµ¢â‚‹â‚) (qâ€² @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”»] B))))
            Q;
      -- let measurement máµ¢ = qáµ¢(B) + Lap(2T/Ïµ)
      máµ¢ â† laplace @ Ïµ/2T @ â„âº[1.0] (qáµ¢ @ ğ•„[Lâˆ, U|m, nâ†¦ğ”»] B)
      -- let Aáµ¢ be n times the distribution whose entries satisfy
      -- Aáµ¢(x) â‰œ Aáµ¢â‚‹â‚(x) Ã— exp(qáµ¢(x) Ã— (máµ¢ - qáµ¢(Aáµ¢â‚‹â‚))/2n)
      return mmap-row @ m @ n @ ğ”» @ ğ”»
        Aáµ¢â‚‹â‚ (sÎ» x : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”»]
        â‡’ (x Ã— (exp ((qáµ¢ @ ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”»] x) Ã—
                      (máµ¢ - ((qáµ¢ @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”»] Aáµ¢â‚‹â‚) / (2 Ã— n))))))))
in mwem
