
-- evaluate a clipping parameter: return how many
-- rows would be clipped by using that parameter
let evalClippingParam =
            sÎ»
               b: ğ”»
               â‡’
                âˆ€ m  : â„•
                  .
              sÎ» <>  xs : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ]
                  â‡’
  let scaled   = mscaleâ‚ƒ @ m @ â„•[1.0] xs b in
  let clipped  = (mclip @ m @ â„•[1.0] @ â„ scaled) in
  let filtered = mfilter-zip @ m @ â„•[1.0] clipped xs in
  timesâ‚… @ â„âº[0.5] @ â„âº[m] â„âº[0.5] (realâ‚‚ @ m (mrows @ m @ â„•[1.0] @ â„ filtered))
in

-- determine the scale of a matrix (i.e. best clipping parameter)
let selectClippingParam =
           âˆ€ m  : â„•,
              Îµ  : â„âº,
              k  : â„•
              .
          sÎ»  xs : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] ,
              Îµ  : â„âº[Îµ] â‡’
          pÎ»    bs : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0
              â‡’
  let target = timesâ‚… @ â„âº[0.9] @ â„âº[m] â„âº[0.9] (realâ‚‚ @ m (mrows @ m @ â„•[1.0] @ ğ”» xs)) in
  let fs = mmap @ â„•[1.0] @ k @ ğ”» @  âˆ€ m  : â„• . (xs : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”»]) âŠ¸ Ã¸ â„âº[0.5â‹…m] @ <> @ <> @ <>
              bs (sÎ» <> b : ğ”» â‡’ evalClippingParam b) in
  bIdx â† svtâ‚ @ ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] @ Îµ @ â„âº[0.0] @ â„âº[0.9â‹…m] @ â„•[k] @ â„âº[m] xs target fs;
  return mindex @ â„•[1.0] @ â„•[k] @ ğ”» bs (idx @ â„•[0.0] â„•[0]) bIdx
in

-- determine the mean of a single column matrix
let colMean =  âˆ€ m   : â„•,
                 k   : â„•,
                 Îµ   : â„âº,
                 Î´   : â„âº
                 .
              sÎ» <mat> mat : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ],
                 Îµ   : â„âº[Îµ] ,
                 Î´   : â„âº[Î´]  ,
                 bs  : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‡’
              pÎ» <mat> m   :  â„âº[m] â‹… 1.0
                 â‡’
  b â† selectClippingParam @ m @ Îµ @ k mat Îµ bs;
  mean â† gaussâ‚‚ @ Îµ @ Î´ @ â„âº[1.0] @ <mat> â„âº[1.0]
        <mat> (divâ‚† @ â„âº[m] (mfold-row-sum @ â„ @ m @ â„•[1.0]
          (mclip @ m @ â„•[1.0] @ â„ (mscaleâ‚ƒ @ m @ â„•[1.0] mat b)))
          (realâ‚‚ @ â„•[m] (mrows @ m @ â„•[1.0] @ ğ”» mat)))
        <mat> Îµ <mat> Î´;
  return mean
in

-- determine the mean of each column in the given matrix
let colMeans = âˆ€ m : â„•, n : â„•, k : â„•, Îµ : â„âº, Î´ : â„âº
                  .
              sÎ»  mat : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ]  ,
                  Îµ   : â„âº[Îµ]  ,
                  Î´   : â„âº[Î´]  ,
                  bs  : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‡’
              pÎ»  m   : â„âº[m] â‹… 1.0
                  â‡’
  pmapcol @ ğ”» @ â„ @ m @ n @ â„âº[(Îµ/m)+Îµ] @ â„âº[Î´/m]
    (pÎ» <col> col : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0 â‡’ colMean @ m @ k @ Îµ @ Î´ col Îµ Î´ bs m) mat
in


let center =
  âˆ€ m : â„•, n : â„•
     .
    sÎ»  <mat> mat    : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ],
      <> means  : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ],
     <> n : â„•[n]
     â‡’
  -- center the values using the column mean
  mmapcolâ‚‚ @ ğ”» @ ğ”» @ m @ n mat means
  (sÎ» <> col : ğ•„ [Lâˆ,U|1.0,m â†¦ ğ”»], <> mean : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ] â‡’
    mmap @ â„•[1.0] @ m @ ğ”» @ ğ”» @ <> @ <> @ <> col
      (sÎ» <> x : ğ”» â‡’ minusâ‚ƒ x (mindex @ â„•[1.0] @ n @ ğ”» mean (idx @ â„•[0.0] â„•[0]) (idxâ‚€ @ â„•[n] n)) )
  )
in

-- determine the scale of each column in the given matrix
let colScaleParams =
   âˆ€ m : â„•, n : â„•, Îµ : â„âº, Î´ : â„âº, k : â„•
     .
  sÎ» mat   : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] ,
     Îµ     : â„âº[Îµ] ,
     Î´     : â„âº[Î´] ,
     bs    : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] ,
     means : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ]â‡’
  pÎ»   n : â„•[n] â‹… 1.0
     â‡’
  pmapcol @ ğ”» @ ğ”» @ â„•[1.0] @ n @ Îµ @ â„âº[0.0]
    (pÎ» <col> col : ğ•„ [Lâˆ,U|1.0,1.0â†¦ğ”»] â‹… 1.0 â‡’ selectClippingParam @ â„•[1.0] @ Îµ @ k col Îµ bs) <mat> (center @ m @ n mat means n)
in

-- given a mean and scale for each column, prepare
-- the given matrix for clipping
let normalize =
   âˆ€ m : â„•, n : â„•
     .
    sÎ» means  : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ],
     scales : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ],
     <mat> mat    : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ],
     n : â„•[n]
     â‡’
  -- center the values using the column mean
  let centered = center @ m @ n <mat> mat means n in

  -- scale the values using the clipping parameters
  mmapcolâ‚‚â‚ @ ğ”» @ ğ”» @ â„•[1.0] @ n centered scales

  ( sÎ» <> col :  ğ•„ [Lâˆ,U|1.0,n â†¦ ğ”»], <> scale : ğ•„ [Lâˆ,U|1.0,n â†¦ ğ”»] â‡’
    mmap @ â„•[1.0] @ n @ ğ”» @ ğ”» @ <> @ <> @ <> col
    ( sÎ» <> x : ğ”» â‡’ divâ‚ƒ x  (mindex @ â„•[1.0] @ n @ ğ”» scale (idx @ â„•[0.0] â„•[0]) (idxâ‚€ @ â„•[n] n))  )
  )
in

let noisySGD =
   âˆ€ m : â„•, n  : â„•, Îµ  : â„âº, k  : â„•, Î´  : â„âº, Î´â€² : â„âº
     .
  sÎ» xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ]  ,
     ys : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] ,
     Îµ  : â„âº[Îµ] ,
     k  : â„•[k] ,
     Î´  : â„âº[Î´] ,
     Î´â€² : â„âº[Î´â€²] â‡’
  pÎ» Î·  : â„ â‹… 1.0 â‡’
   let colnum = (mcols @ m @ n @ ğ”» xs) in
   let mâ‚€ = mcreate @ â„•[1.0] @ â„•[n] @ â„ â„•[1] colnum (sÎ» i : ğ•€[1.0] , j : ğ•€[n] â‡’ 0.0) in
   aloop @ Îµ @ Î´ @ Î´â€² @ k @ n @ <xs,ys>
     (pÎ» <xs,ys> Î¸ : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ] â‹… 1.0 â‡’
       g â† mgauss @ Îµ @ Î´ @ â„•[1.0] @ n Îµ Î´
             (mLipGrad @ m @ n Î¸ (mclip @ m @ n @ ğ”» xs) ys) ;
       return (matsub @ â„•[1.0] @ n Î¸ g))
     mâ‚€
     Î´â€²
in

let main =
  âˆ€ m : â„•, n : â„•, k : â„•, Îµ : â„âº, Î´ : â„âº, Î´â€² : â„âº
     .
  pÎ» xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 ,
     ys : ğ•„ [Lâˆ, U|1.0, 1.0â†¦ğ”» ] â‹… 1.0 ,
     Îµ   : â„âº[Îµ] â‹… 1.0,
     k  : â„•[k] â‹… 1.0,
     Î´  : â„âº[Î´] â‹… 1.0,
     Î´â€² : â„âº[Î´â€²] â‹… 1.0,
     Î·  : â„ â‹… 1.0,
     bs  : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0,
     m   : â„âº[m] â‹… 1.0,
     n   : â„•[n] â‹… 1.0
     â‡’
  means  â† colMeans @ m @ n @ k @ Îµ @ Î´ xs Îµ Î´ bs m;
  scales â† colScaleParams @ m @ n @ Îµ @ Î´ @ k xs Îµ Î´ bs (mdisc @ â„•[1.0] @ n means) n;
  -- let normalizeF =  in
  noisySGD @ â„•[1.0] @ n @ Îµ @ k @ Î´ @ Î´â€² (normalize @ m @ n (mdisc @ â„•[1.0] @ n means) scales <xs> xs n) ys Îµ k Î´ Î´â€² Î·

in main
