
-- evaluate a clipping parameter: return how many
-- rows would be clipped by using that parameter
let evalClippingParam =
            sÎ»
               b: ğ”»
               â‡’
                âˆ€ m  : â„•
                  .
              sÎ»  xs : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ]
                  â‡’
  let scaled   = mscaleâ‚ƒ @ m @ â„•[1.0] xs b in
  let clipped  = (mclip @ m @ â„•[1.0] @ â„ scaled) in
  let filtered = mfilter-zip @ m @ â„•[1.0] clipped xs in
  timesâ‚… @ â„âº[0.5] @ â„âº[m] â„âº[0.5] (realâ‚‚ @ m (mrows @ m @ â„•[1.0] @ â„ filtered))
in

-- determine the scale of a matrix (i.e. best clipping parameter)
let selectClippingParam =
           âˆ€ m  : â„•,
              Îµ  : â„âº,
              k  : â„•
              .
          pÎ»  xs : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0 ,
              Îµ  : â„âº[Îµ] â‹… 1.0 ,
              bs : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0
              â‡’
  let target = timesâ‚… @ â„âº[0.9] @ â„âº[m] â„âº[0.9] (realâ‚‚ @ m (mrows @ m @ â„•[1.0] @ ğ”» xs)) in
  let fs = mmap @ â„•[1.0] @ k @ ğ”» @ âˆ€ n  : â„• . (xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”»]) âŠ¸ Ã¸ â„âº[0.5â‹…m] @ <> @ <> @ <>
              bs (sÎ» <> b : ğ”» â‡’ evalClippingParam b @ m) in
  bIdx â† svt @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] @ Îµ @ Î´ xs fs;
  return mindex @ m @ â„•[1.0] @ ğ”» bs (idx â„•[0]) bIdx
in

-- determine the mean of a single column matrix
let colMean =  âˆ€ m   : â„•,
                 k   : â„•,
                 Îµ   : â„âº,
                 Î´   : â„âº
                 .
              pÎ» mat : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0 ,
                 Îµ   : â„âº[Îµ] â‹… 1.0 ,
                 Î´   : â„âº[Î´] â‹… 1.0 ,
                 bs  : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0,
                 m   :  â„âº[m] â‹… 1.0
                 â‡’
  b â† selectClippingParam @ m @ Îµ @ k mat Îµ bs;
  let scaled   = mscaleâ‚ƒ @ m @ â„•[1.0] mat b in
  let clipped  = mclip @ m @ â„•[1.0] @ ğ”» scaled in
  let sum      = mfold-row-sum @ ğ”» @ m @ â„•[1.0] clipped in
  mean â† gauss @ Îµ @ Î´ @ â„âº[1.0/m] Îµ Î´ (divâ‚… â„âº[1.0] m) (divâ‚‚ sum (realâ‚ (rows mat)));
  return mean
  -- return (disc mean)
in

-- determine the mean of each column in the given matrix
let colMeans = âˆ€ m : â„•, n : â„•, k : â„•, Îµ : â„âº, Î´ : â„âº
                  .
              pÎ»  mat : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 ,
                  Îµ   : â„âº[Îµ] â‹… 1.0 ,
                  Î´   : â„âº[Î´] â‹… 1.0 ,
                  bs  : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0
                  â‡’
  pmapcol @ ğ”» @ ğ”» @ m @ n @ Îµ mat
    (sÎ» col : ğ”» â‡’ colMean @ m @ k @ Îµ @ Î´ col Îµ Î´ bs )
in


let center =
  âˆ€ m : â„•, n : â„•
     .
    sÎ» mat    : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ],
     means  : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ]
     â‡’
  -- center the values using the column mean
  mmapcolâ‚‚ @ ğ”» @ ğ”» @ m @ n @ Îµ mat means
  (sÎ» col : ğ”», mean : ğ”» â‡’
    mmap â„•[1] @ k @ ğ”» @ ğ”» @ <> @ <> @ <> col
      (sÎ» x : ğ”» â‡’ minusâ‚€ x (mindex @ m @ n @ ğ”» mean (idx â„•[0]) (idx â„•[0])) )
  )
in

-- determine the scale of each column in the given matrix
let colScaleParams =
   âˆ€ m : â„•, n : â„•, Îµ : â„âº, Î´ : â„âº, k : â„•
     .
  pÎ» mat   : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0,
     Îµ     : â„âº[Îµ] â‹… 1.0,
     Î´     : â„âº[Î´] â‹… 1.0,
     bs    : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0,
     means : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ] â‹… 1.0
     â‡’
  pmap-col @ ğ”» @ ğ”» @ m @ n @ Îµ (center @ m @ n mat means)
    (sÎ» col : ğ”» â‡’ selectClippingParam @ m @ Îµ @ k col Îµ bs )
in

-- given a mean and scale for each column, prepare
-- the given matrix for clipping
let normalize =
   âˆ€ m : â„•, n : â„•
     .
    sÎ» means  : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ],
     scales : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ],
     mat    : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ]
     â‡’
  -- center the values using the column mean
  let centered = center @ m @ n mat means in

  -- scale the values using the clipping parameters
  mmapcolâ‚‚ @ ğ”» @ ğ”» @ â„•[1.0] @ n centered scales

  ( sÎ» col : ğ”», scale : ğ”» â‡’
    mmap @ m @ n @ ğ”» @ ğ”» @ <> @ <> @ <> col
    ( sÎ» x : ğ”» â‡’ divâ‚‚ x  (mindex @ m @ n @ ğ”» scale (idx â„•[0]) (idx â„•[0]))  )
  )
in

let noisySGD =
   âˆ€ m : â„•, n  : â„•, Îµ  : â„âº, k  : â„•, Î´  : â„âº, Î´â€² : â„âº
     .
  pÎ» xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 ,
     ys : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0 ,
     Îµ  : â„âº[Îµ] â‹… 1.0,
     k  : â„•[k] â‹… 1.0,
     Î´  : â„âº[Î´] â‹… 1.0,
     Î´â€² : â„âº[Î´â€²] â‹… 1.0,
     Î·  : â„ â‹… 1.0
     â‡’
   let colnum = (mcols @ m @ n @ ğ”» xs) in
   let mâ‚€ = mcreate @ â„•[1.0] @ â„•[n] @ â„ â„•[1] colnum (sÎ» i : ğ•€[1.0] , j : ğ•€[n] â‡’ 0.0) in
   aloop @ Îµ @ Î´ @ Î´â€² @ k @ n @ <xs,ys>
     (pÎ» <xs,ys> Î¸ : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ] â‹… 1.0 â‡’
       g â† mgauss @ Îµ @ Î´ @ â„•[1.0] @ n Îµ Î´
             (mLipGrad @ m @ n Î¸ (mclip @ m @ n @ ğ”» xs) ys) ;
       return (matsub @ â„•[1.0] @ n Î¸ g))
     mâ‚€
     Î´â€²
in

let main =
  âˆ€ m : â„•, n : â„•, k : â„•, Îµ : â„âº, Î´ : â„âº, Î´â€² : â„âº
     .
  pÎ» xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 ,
     ys : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0 ,
     Îµ   : â„âº[Îµ] â‹… 1.0,
     k  : â„•[k] â‹… 1.0,
     Î´  : â„âº[Î´] â‹… 1.0,
     Î´â€² : â„âº[Î´â€²] â‹… 1.0,
     Î·  : â„ â‹… 1.0,
     bs  : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0
     â‡’
  means  â† colMeans @ m @ n @ k @ Îµ @ Î´ xs Îµ Î´ bs;
  scales â† colScaleParams @ m @ n @ Îµ Î´ @ k xs Îµ Î´ bs means;
  let normalizeF = normalize @ m @ n means scales in
  noisySGD @ m @ n @ Îµ @ k @ Î´ @ Î´â€² normalizeF xs ys Îµ k Î´ Î´â€² Î·

in main
