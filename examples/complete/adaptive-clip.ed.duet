let query = sÎ»
               b: ğ”»
               â‡’
              âˆ€  m  : â„•,
                  n  : â„•
                  .
                sÎ» <> xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ]
                  â‡’
  let scaled   = mscaleâ‚ƒ @ m @ n xs b in
  let clipped  = mclip @ m @ n @ â„ scaled in
  let filtered = mfilter-zip @ m @ n clipped xs in
  timesâ‚… @ â„âº[0.5] @ â„âº[m] â„âº[0.5] (realâ‚‚ @ m (mrows @ m @ n @ â„ filtered))
in

let pick = âˆ€ m  : â„•,
              n  : â„•,
              Îµ  : â„âº,
              k  : â„•
              .
            sÎ»  xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ],
              Îµ  : â„âº[Îµ] â‡’
            pÎ»  bs : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0
              â‡’
  let target = timesâ‚… @ â„âº[0.9] @ â„âº[m] â„âº[0.9] (realâ‚‚ @ m (mrows @ m @ n @ ğ”» xs)) in
  let fs = mmap @ â„•[1.0] @ k @ ğ”» @ âˆ€ n  : â„• . (xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”»]) âŠ¸ Ã¸ â„âº[0.5â‹…m] @ <> @ <> @ <>
              bs (sÎ» <> b : ğ”» â‡’ query b @ m) in
  svt @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] @ Îµ @ Î´ @ â„âº[0.9â‹…m] @ â„•[k] @ â„âº[m] xs target fs
in

let scaleAndClip = âˆ€ m  : â„•,
                      n  : â„•
                      .
                    sÎ»  xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ],
                      b: ğ”»
                      â‡’
  let scaled   = mscaleâ‚ƒ @ m @ n xs b in
  let clipped  = (mclip @ m @ n @ â„ scaled) in
  clipped
in

let main =  âˆ€ m  : â„•,
              n  : â„•,
              Îµ  : â„âº,
              k  : â„•,
              Î´  : â„âº,
              Î´â€² : â„âº,
              k  : â„•
              .
          pÎ»  xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0  ,
              ys : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0  ,
              Îµ  : â„âº[Îµ] â‹… 1.0 ,
              k  : â„•[k] â‹… 1.0 ,
              Î´  : â„âº[Î´] â‹… 1.0 ,
              Î´â€² : â„âº[Î´â€²] â‹… 1.0 ,
              Î·  : â„ â‹… 1.0 ,
              bs : ğ•„ [Lâˆ, U|1.0, kâ†¦ğ”» ] â‹… 1.0
              â‡’
  let colnum = (mcols @ m @ n @ ğ”» xs) in
  let mâ‚€ = mcreate @ â„•[1.0] @ â„•[n] @ â„ â„•[1] colnum (sÎ» i : ğ•€[1.0] , j : ğ•€[n] â‡’ 0.0) in
  b â† pick @ m @ n @ Îµ @ k xs Îµ bs;
  -- let c = (scaleAndClip @ m @ n xs1 (mindex @ â„•[1.0] @ â„•[k] @ ğ”» bs (idx @ â„•[0.0] â„•[0]) b)) in
  aloop @ Îµ @ Î´ @ Î´â€² @ k @ n @ <xs,ys>
    (pÎ» <xs,ys> Î¸ : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ] â‹… 1.0 â‡’
      let s = divâ‚„ @ â„âº[1.0] @ â„âº[m] â„âº[1.0] (realâ‚‚ @ â„•[m] (mrows @ m @ n @ ğ”» xs)) in
      g â† mgaussâ‚ @ Îµ @ Î´ @ â„•[1.0] @ n @ <xs,ys> Îµ Î´
            (mLipGrad @ m @ n Î¸ (mclipscale @ m @ n @ ğ”» (mindex @ â„•[1.0] @ â„•[k] @ ğ”» bs (idx @ â„•[0.0] â„•[0]) b) xs) ys) ;
      return (matsub @ â„•[1.0] @ n Î¸ g))
    mâ‚€
    Î´â€²


in main
