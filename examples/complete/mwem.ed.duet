-- MWEM in Contextual Duet
let mwem =  âˆ€ m : â„•, n : â„•, Îµ : â„âº, t : â„• .
           -- data set B over domain D
           pÎ» B : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 ,
              -- set Q of linear queries
              Q : ğ•„ [Lâˆ, U|1.0, nâ†¦ âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„• ] â‹… 1.0 ,
              -- number of iterations T
              T  : â„•[t] â‹… 1.0,
              -- privacy parameter Ïµ > 0
              Îµ  : â„âº[Îµ] â‹… 1.0,
              -- starting synthetic data: n times the uniform distribution over D
              Aâ‚€ : ğ•„[Lâˆ, U|m, nâ†¦ğ”»] â‹… 1.0,
              -- term-level matrix dimensions
              m  : â„•[m] â‹… 1.0, n  : â„•[n] â‹… 1.0 â‡’
  -- for iteration i = 1,...,T
  seqloop @ â„âº[Ïµ/t] @ T @ m @ n @ <B>
    (pÎ» <B> Aáµ¢â‚šáµ£â‚‘ : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0 â‡’
      -- select a query qáµ¢ âˆˆ Q using the exponential mechanism
      -- parameterized with epsilon value Ïµ/2T and the score function
      -- sáµ¢(B, q) = |q(Aáµ¢â‚‹â‚) - q(B)|
      qáµ¢i â† exponentialâ‚‚ @ m @ n @ âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„• @ â„âº[1.0] @ â„âº[2.0] @ â„âº[0.5â‹…Ïµ/t]
            (sÎ» <Bâ€²> Bâ€² : ğ•„ [Lâˆ, U|m, nâ†¦ğ”»]
              â‡’ (sÎ» <Bâ€²,qâ€²> qâ€² : âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„•
                â‡’ (abs (qâ€² @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”»] Aáµ¢â‚šáµ£â‚‘) (qâ€² @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”»] Bâ€²)))) Q B;
      -- let measurement máµ¢ = qáµ¢(B) + Lap(2T/Ïµ)
      let qáµ¢ = (mindex @ â„•[1.0] @ n @ âˆ€ Ï„ : â˜† . (c : Ï„) âŠ¸ [câ‹…1.0] â„• Q (idx @ â„•[0.0] â„•[0]) qáµ¢i) in
      máµ¢ â† laplace @ â„âº[0.5â‹…Ïµ/t] @ â„âº[1.0] @ <>
            (realâ‚ (qáµ¢ @ ğ•„[Lâˆ, U|m, nâ†¦ğ”»] B));
      -- let Aáµ¢ be n times the distribution whose entries satisfy
      -- Aáµ¢(x) â‰œ Aáµ¢â‚‹â‚(x) Ã— exp(qáµ¢(x) Ã— (máµ¢ - qáµ¢(Aáµ¢â‚‹â‚))/2n)
      return mmap-row @ m @ n @ ğ”» @ â„
        Aáµ¢â‚šáµ£â‚‘ (sÎ» <> x : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”»]
        â‡’ (mscaleâ‚€ @ â„•[1.0] @ n x
            (exp (timesâ‚€
              (qáµ¢ @ ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”»] x)
              (minusâ‚€ máµ¢ (divâ‚€ (qáµ¢ @ ğ•„ [Lâˆ, U|m, nâ†¦ğ”»] Aáµ¢â‚šáµ£â‚‘) (times @ n 2 n)))))))) B
in mwem
