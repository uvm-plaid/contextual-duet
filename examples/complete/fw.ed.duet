
let main = âˆ€  m  : â„•,
              n  : â„•,
              Îµ  : â„âº,
              Î´  : â„âº,
              k  : â„•
              .
          pÎ»  xs : ğ•„ [Lâˆ, U|m, nâ†¦ğ”» ] â‹… 1.0  ,
              ys : ğ•„ [Lâˆ, U|m, 1.0â†¦ğ”» ] â‹… 1.0  ,
              Îµ  : â„âº[Îµ] â‹… 1.0 ,
              Î´  : â„âº[Î´] â‹… 1.0 ,
              k  : â„•[k] â‹… 1.0,
              m  : â„•[m] â‹… 1.0,
              n  : â„•[n] â‹… 1.0
              â‡’
  let d = mcols @ m @ n @ ğ”» xs in
  let mâ‚€ = mcreate @ â„•[1.0] @ â„•[n] @ â„ â„•[1] d  (sÎ» i : ğ•€[1.0] , j : ğ•€[n] â‡’ 0.0) in
  let indexes = mcreate @ â„•[1.0] @ â„•[n] @
  ğ•€[n] Ã¸ âŠ  Ã¸ â„
  â„•[1] d (sÎ» <i> i : ğ•€[1.0] , <j> j : ğ•€[n] â‡’
            âŸ¨modâ‚„ @ n j (dynâ‚ @ n d) <>,<> sign (realâ‚ (minusâ‚ (dynâ‚ƒ @ n j) (dynâ‚ @ n d)))âŸ©) in

  loop @ Îµ @ â„âº[0.0] @ Î´ @ k @ n @ <xs,ys>
    (pÎ» <xs,ys> t : â„• â‹… 1.0,
        <xs,ys> Î¸ : ğ•„ [Lâˆ, U|1.0, nâ†¦ğ”» ] â‹… 1.0 â‡’
      let Î¼ = divâ‚… @ â„âº[1.0] â„âº[1.0] (plusâ‚‚ (realâ‚ t) 2.0) in
      let s = divâ‚„ @ â„âº[1.0] @ m â„âº[1.0] (realâ‚‚ @ m (mrows @ m @ n @ ğ”» xs)) in
      p â† exponentialâ‚š @ â„•[1.0] @ n
        @ ğ•€[n] Ã¸ âŠ  Ã¸ â„
        @ â„âº[1.0] @ Îµ @ Î´ @ <xs,ys> -- s Îµ
          (pÎ» <x,xs,ys> x : ğ•€[n] Ã¸ âŠ  Ã¸ â„ â‹… 1.0 â‡’
            let c = fst x in
            let s = snd x in
            g â† mgauss @ Îµ @ Î´ @ â„•[1.0] @ n Îµ Î´
                    (mLipGrad @ m @ n Î¸ (mclip @ m @ n @ ğ”» xs) ys);
            return mindex @ â„•[1.0] @ n @ â„ g (idx @ â„•[0.0] â„•[0]) c ) indexes ;

      let gâ‚€ = mcreate @ â„•[1.0] @ â„•[n] @ â„ â„•[1] d  (sÎ» i : ğ•€[1.0] , j : ğ•€[n] â‡’ 0.0) in
      let zz = mindexâ‚ @ â„•[1.0] @ n
                @ ğ•€[n] Ã¸ âŠ  Ã¸ â„
                indexes (idx @ â„•[0.0] â„•[0]) p in
      let s = snd zz in
      let i = fst zz in
      let gâ‚š = mupdateâ‚ @ â„•[1.0] @ n @ â„ gâ‚€ (idx @ â„•[0.0] â„•[0]) i (timesâ‚‚ s (realâ‚ 100)) in
      let Î¸' = mmap @ â„•[1.0] @ n @ ğ”» @ ğ”» @ <> @ <> @ <>
                  Î¸ (sÎ» <> x : ğ”» â‡’ timesâ‚ƒ (disc @ â„ (minusâ‚‚ 1.0 Î¼)) x ) in
      let Î¸'' = mconv @ â„•[1.0] @ n Î¸' in
      let gâ‚š' = mmapâ‚ @ â„•[1.0] @ n @ â„ @ â„ @ <> @ <> @ <> gâ‚š (sÎ» <> x : â„ â‡’ timesâ‚‚ Î¼  (timesâ‚‚ 100.0 x) ) in
      return mmap2â‚ @ â„•[1.0] @ n @ â„ @ â„ @ <> @ <> @ <> Î¸'' gâ‚š' (sÎ» <> x : â„, <> y : â„ â‡’ plusâ‚‚ x y )
    )
    mâ‚€
    Î´
in main
